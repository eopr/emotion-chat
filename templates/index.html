<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Emotion Chat</title>
  <style>
    body { font-family: sans-serif; margin: 20px; overflow: hidden; }
    #messages { list-style: none; padding: 0; height: 60vh; overflow-y: auto; display: flex; flex-direction: column; justify-content: flex-end; }
    #messages li { margin-bottom: 12px; }
    #videoPreviewWrapper {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 150px;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 8px;
      padding: 10px;
      color: white;
    }
    #videoPreview {
      width: 120px;
      height: auto;
      border-radius: 4px;
    }
    #emotionLabel {
      margin-top: 6px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ðŸ’¬ Emotion Chat</h1>

  <form id="chatForm">
    <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off" required />
    <button type="submit">Send</button>
  </form>

  <ul id="messages"></ul>

  <div id="videoPreviewWrapper" style="display:none">
    <video id="videoPreview" autoplay muted></video>
    <div id="emotionLabel"></div>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const socket = io({ transports: ['websocket'] });

    let username = '';
    let room = '';
    while (!username) username = prompt('Enter your username:');
    while (!room) room = prompt('Enter room ID to join:');
    socket.emit('join_room', { user: username, room: room });

    const form = document.getElementById('chatForm');
    const input = document.getElementById('messageInput');
    const messages = document.getElementById('messages');
    const video = document.getElementById('videoPreview');
    const videoWrapper = document.getElementById('videoPreviewWrapper');
    const emotionLabel = document.getElementById('emotionLabel');

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
        videoWrapper.style.display = 'flex';
      })
      .catch(console.error);

    function captureImage() {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      return canvas.toDataURL('image/jpeg', 0.7);
    }

    setInterval(() => {
    const snapshot = captureImage();
    socket.emit('emotion_ping', { image: snapshot, user: username, room: room });
    }, 4000);  // every 4 seconds


    form.addEventListener('submit', e => {
      e.preventDefault();
      const msg = input.value.trim();
      if (!msg) return;
      const imageData = captureImage();
      socket.emit('send_message', { text: msg, image: imageData, user: username, room: room });
      input.value = '';
    });

    socket.on('emotion_update', data => {
      const { emotion } = data;
      emotionLabel.textContent = emotion;
      videoWrapper.style.display = 'flex';
    });

    socket.on('receive_message', data => {
      const item = document.createElement('li');
      item.innerHTML = `<strong>${data.user}</strong> ðŸ—£ï¸ (${data.emotion}) ${data.text}`;
      if (data.image) {
        const img = document.createElement('img');
        img.src = 'data:image/jpeg;base64,' + data.image;
        img.width = 150;
        img.style.display = 'block';
        img.style.marginTop = '5px';
        item.appendChild(img);
      }
      messages.appendChild(item);
      messages.scrollTop = messages.scrollHeight;
    });

    socket.on('system_message', data => {
      const item = document.createElement('li');
      item.style.fontStyle = 'italic';
      item.style.color = 'gray';
      item.textContent = data.text;
      messages.appendChild(item);
      messages.scrollTop = messages.scrollHeight;
    });
  </script>
</body>
</html>
